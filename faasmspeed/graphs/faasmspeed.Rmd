---
title: "Faasm latency measurements"
author: "Jakub Szewczyk"
date: "08-09-2021"
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
library(tidyverse)
library(rio)
library(scales)
knitr::opts_chunk$set(echo = FALSE)
```

```{r read_csv, include=FALSE, cache=TRUE, cache.extra = file.info("table.csv")}
raw_csv <- import('table.csv')
```

```{r tidy_bench}
t_data <- raw_csv %>%
  mutate (
    opts_host = factor(opts_host),
    opts_user = factor(opts_user),
    opts_function = factor(opts_function),
    total_requests = avg_rps_avg_rps * opts_req_time,
  )

```

## Latencies

```{r plot_lat}
plot_scale <- 1.0/1000.0
ggplot(t_data,
    aes(x = avg_rps_avg_rps, ymin = latency_us_q1pct*plot_scale, ymax = latency_us_q99pct*plot_scale, lower = latency_us_q1*plot_scale, middle = latency_us_med*plot_scale, upper = latency_us_q3*plot_scale)) +
  geom_boxplot(stat = 'identity', aes(group = interaction(avg_rps_avg_rps, opts_function), color = opts_function)) +
  scale_x_continuous(trans = 'log', breaks = log_breaks(n=20), label = scales::label_comma(accuracy = 1)) +
  scale_y_continuous(trans = 'log', breaks = log_breaks(n=20), label = scales::label_comma(accuracy = 1)) +
  labs(title = "Latency for a given request per second rate") +
  xlab("Req/s") + ylab("milliseconds")
```

```{r plot_lat_zoom}
plot_scale <- 1.0/1000.0
ggplot(t_data %>% filter(avg_rps_avg_rps > 250),
    aes(x = avg_rps_avg_rps, ymin = latency_us_q1pct*plot_scale, ymax = latency_us_q99pct*plot_scale, lower = latency_us_q1*plot_scale, middle = latency_us_med*plot_scale, upper = latency_us_q3*plot_scale)) +
  geom_boxplot(stat = 'identity', aes(group = interaction(avg_rps_avg_rps, opts_function), color = opts_function)) +
  scale_x_continuous(trans = 'log', breaks = log_breaks(n=20), label = scales::label_comma(accuracy = 1)) +
  scale_y_continuous(trans = 'log', breaks = log_breaks(n=20), label = scales::label_comma(accuracy = 1)) +
  labs(title = "Latency for a given request per second rate") +
  xlab("Req/s") + ylab("milliseconds")
```

```{r plot_lat_smooth}
plot_scale <- 1.0/1000.0
ggplot(t_data,
    aes(x = avg_rps_avg_rps, ymin = latency_us_q1*plot_scale, y = latency_us_med*plot_scale, ymax = latency_us_q3*plot_scale)) +
  geom_smooth(stat = 'identity', aes(group = interaction(opts_function), color = opts_function)) +
  scale_x_continuous(trans = 'log', breaks = log_breaks(n=20), label = scales::label_comma(accuracy = 1)) +
  scale_y_continuous(trans = 'log', breaks = log_breaks(n=20), label = scales::label_comma(accuracy = 1)) +
  labs(title = "Latency for a given request per second rate") +
  xlab("Req/s") + ylab("milliseconds")
```

```{r plot_lat_smooth_zoom}
plot_scale <- 1.0/1000.0
ggplot(t_data %>% filter(avg_rps_avg_rps > 250),
    aes(x = avg_rps_avg_rps, ymin = latency_us_q1*plot_scale, y = latency_us_med*plot_scale, ymax = latency_us_q3*plot_scale)) +
  geom_smooth(stat = 'identity', aes(group = interaction(opts_function), color = opts_function)) +
  scale_x_continuous(trans = 'identity', breaks = log_breaks(n=20), label = scales::label_comma(accuracy = 1)) +
  scale_y_continuous(trans = 'log', breaks = log_breaks(n=20), label = scales::label_comma(accuracy = 1)) +
  labs(title = "Latency for a given request per second rate") +
  xlab("Req/s") + ylab("milliseconds")
```

```{r plot_cpu_load_no_hello}
ggplot(t_data) +
  geom_line(stat = 'identity', aes(x = avg_rps_avg_rps, y = monitor_computeprocs_running_avg, group = interaction(opts_function), color = interaction('compute',opts_function))) +
  geom_line(stat = 'identity', aes(x = avg_rps_avg_rps, y = monitor_storageprocs_running_avg, group = interaction(opts_function), color = interaction('storage',opts_function))) +
  scale_x_continuous(trans = 'log', breaks = log_breaks(n=20), label = scales::label_comma(accuracy = 1)) +
  scale_y_continuous(trans = 'identity') +
  labs(title = "Average RUNNING threads") +
  xlab("Req/s") + ylab("count")
```

```{r plot_cpu_cswitches}
ggplot(t_data %>% filter(avg_rps_avg_rps>50)) +
  geom_line(stat = 'identity', aes(x = avg_rps_avg_rps, y = monitor_computecswitches_sum / (opts_req_time), group = interaction(opts_function), color = interaction('compute',opts_function))) +
  geom_line(stat = 'identity', aes(x = avg_rps_avg_rps, y = monitor_storagecswitches_sum / (opts_req_time), group = interaction(opts_function), color = interaction('storage',opts_function))) +
  scale_x_continuous(trans = 'log', breaks = log_breaks(n=20), label = scales::label_comma(accuracy = 1)) +
  scale_y_continuous(trans = 'identity') +
  labs(title = "Average context switches per second") +
  xlab("Req/s") + ylab("count/sec")
```

```{r plot_cpu_ms_no_hello}
ggplot(t_data) +
  geom_line(stat = 'identity', aes(x = avg_rps_avg_rps, y = (monitor_computecpums_user_sum + monitor_computecpums_system_sum + monitor_computecpums_nice_sum) / total_requests, group = interaction(opts_function), color = interaction('compute',opts_function))) +
  geom_line(stat = 'identity', aes(x = avg_rps_avg_rps, y = (monitor_storagecpums_user_sum + monitor_storagecpums_system_sum + monitor_storagecpums_nice_sum) / total_requests, group = interaction(opts_function), color = interaction('storage',opts_function))) +
  scale_x_continuous(trans = 'log', breaks = log_breaks(n=20), label = scales::label_comma(accuracy = 1)) +
  scale_y_continuous(trans = 'identity') +
  labs(title = "Average CPU ms per request (user+system)") +
  xlab("Req/s") + ylab("count")
```

```{r plot_mem_active_no_hello}
ggplot(t_data) +
  geom_line(stat = 'identity', aes(x = avg_rps_avg_rps, y = monitor_computemem_active_avg, group = interaction(opts_function), color = interaction('compute',opts_function))) +
#  geom_line(stat = 'identity', aes(x = avg_rps_avg_rps, y = monitor_storagemem_active_avg, group = interaction(opts_function), color = interaction('storage',opts_function))) +
  scale_x_continuous(trans = 'log', breaks = log_breaks(n=20), label = scales::label_comma(accuracy = 1)) +
  scale_y_continuous(trans = 'log', breaks = log_breaks(n=20), label = scales::label_comma(accuracy = 1)) +
  labs(title = "Average Active memory per request") +
  xlab("Req/s") + ylab("bytes")
```

```{r plot_net_tx_bytes_no_hello}
ggplot(t_data) +
  geom_line(stat = 'identity', aes(x = avg_rps_avg_rps, y = monitor_computenet_tx_bytes_sum / total_requests, group = interaction(opts_function), color = interaction('compute',opts_function))) +
  geom_line(stat = 'identity', aes(x = avg_rps_avg_rps, y = monitor_storagenet_tx_bytes_sum / total_requests, group = interaction(opts_function), color = interaction('storage',opts_function))) +
  scale_x_continuous(trans = 'log', breaks = log_breaks(n=20), label = scales::label_comma(accuracy = 1)) +
  scale_y_continuous(trans = 'log', breaks = log_breaks(n=20), label = scales::label_comma(accuracy = 1)) +
  labs(title = "Total bytes per request sent from node over network") +
  xlab("Req/s") + ylab("bytes/request")
```

```{r plot_net_tx_sum_bytes_no_hello}
ggplot(t_data) +
  geom_line(stat = 'identity', aes(x = avg_rps_avg_rps, y = (monitor_computenet_tx_bytes_sum + monitor_storagenet_tx_bytes_sum) / total_requests, group = interaction(opts_function), color = opts_function)) +
  scale_x_continuous(trans = 'log', breaks = log_breaks(n=20), label = scales::label_comma(accuracy = 1), expand = c(0.01, 0.01)) +
  scale_y_continuous(trans = 'identity', expand = c(0.1,0), limits = c(0, NA), label = scales::label_comma(accuracy = 1)) +
  labs(title = "Total bytes per request sent over network") +
  xlab("Req/s") + ylab("bytes/request")
```

```{r plot_net_tx_sum_bytes_per_sec}
ggplot(t_data) +
  geom_line(stat = 'identity', aes(x = avg_rps_avg_rps, y = (monitor_computenet_tx_bytes_sum + monitor_storagenet_tx_bytes_sum) / (opts_req_time), group = interaction(opts_function), color = opts_function)) +
  scale_x_continuous(trans = 'log', breaks = log_breaks(n=20), label = scales::label_comma(accuracy = 1), expand = c(0.01, 0.01)) +
  scale_y_continuous(trans = 'identity', expand = c(0.1,0), limits = c(0, NA), label = scales::label_comma(accuracy = 1)) +
  labs(title = "Total bytes per second sent over network") +
  xlab("Req/s") + ylab("bytes/second")
```
